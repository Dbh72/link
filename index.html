<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bilancia Numerica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        .font-inter {
            font-family: 'Inter', sans-serif
        }
        .min-h-screen {
            min-height: 100vh
        }
        .bg-gradient-to-br {
            background-image: linear-gradient(to bottom right, var(--tw-gradient-stops))
        }
        .from-gray-100 {
            --tw-gradient-from: #f3f4f6;
            --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(243, 244, 246, 0))
        }
        .to-gray-300 {
            --tw-gradient-to: #d1d5db
        }
        .flex {
            display: flex
        }
        .flex-col {
            flex-direction: column
        }
        .items-center {
            align-items: center
        }
        .justify-center {
            justify-content: center
        }
        .p-4 {
            padding: 1rem
        }
        .bg-white {
            background-color: #fff
        }
        .p-6 {
            padding: 1.5rem
        }
        .rounded-xl {
            border-radius: .75rem
        }
        .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, .1), 0 4px 6px -2px rgba(0, 0, 0, .05)
        }
        .mb-6 {
            margin-bottom: 1.5rem
        }
        .w-full {
            width: 100%
        }
        .max-w-2xl {
            max-width: 42rem
        }
        .md\:flex-row {
            flex-direction: row
        }
        .gap-4 {
            gap: 1rem
        }
        .flex-1 {
            flex: 1 1 0%
        }
        .block {
            display: block
        }
        .text-lg {
            font-size: 1.125rem
        }
        .font-semibold {
            font-weight: 600
        }
        .text-gray-700 {
            color: #374151
        }
        .mb-2 {
            margin-bottom: .5rem
        }
        .p-2 {
            padding: .5rem
        }
        .border {
            border-width: 1px
        }
        .border-gray-300 {
            border-color: #d1d5db
        }
        .rounded-md {
            border-radius: .375rem
        }
        .focus\:ring-2:focus {
            --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
            --tw-ring-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow);
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000)
        }
        .focus\:ring-blue-400:focus {
            --tw-ring-color: #60a5fa
        }
        .bg-blue-600 {
            background-color: #2563eb
        }
        .hover\:bg-blue-700:hover {
            background-color: #1d4ed8
        }
        .text-white {
            color: #fff
        }
        .font-bold {
            font-weight: 700
        }
        .py-3 {
            padding-top: .75rem;
            padding-bottom: .75rem
        }
        .px-6 {
            padding-left: 1.5rem;
            padding-right: 1.5rem
        }
        .rounded-lg {
            border-radius: .5rem
        }
        .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, .1), 0 2px 4px -1px rgba(0, 0, 0, .06)
        }
        .transition {
            transition-property: background-color, border-color, color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter;
            transition-timing-function: cubic-bezier(.4, 0, .2, 1);
            transition-duration: 150ms
        }
        .duration-300 {
            transition-duration: 300ms
        }
        .ease-in-out {
            transition-timing-function: cubic-bezier(.4, 0, .2, 1)
        }
        .transform {
            transform: var(--tw-transform)
        }
        .hover\:scale-105:hover {
            --tw-scale-x: 1.05;
            --tw-scale-y: 1.05;
            transform: var(--tw-transform)
        }
        .sm\:w-auto {
            width: auto
        }
        .bg-red-500 {
            background-color: #ef4444
        }
        .hover\:bg-red-600:hover {
            background-color: #dc2626
        }
        .text-red-600 {
            color: #dc2626
        }
        .mt-4 {
            margin-top: 1rem
        }
        .text-center {
            text-align: center
        }
        .bg-gray-50 {
            background-color: #f9fafb
        }
        .border-gray-200 {
            border-color: #e5e7eb
        }
        .mt-6 {
            margin-top: 1.5rem
        }
        .text-gray-800 {
            color: #1f2937
        }
        .relative {
            position: relative
        }
        .max-w-xl {
            max-width: 36rem
        }
        .aspect-video {
            aspect-ratio: 16/9
        }
        .mt-8 {
            margin-top: 2rem
        }
        .mb-12 {
            margin-bottom: 3rem
        }
        @keyframes tiltClockwise {
            0% {
                transform: rotate(0deg)
            }
            50% {
                transform: rotate(10deg)
            }
            100% {
                transform: rotate(0deg)
            }
        }
        @keyframes tiltCounterClockwise {
            0% {
                transform: rotate(0deg)
            }
            50% {
                transform: rotate(-10deg)
            }
            100% {
                transform: rotate(0deg)
            }
        }
        .beam-tilt-clockwise {
            animation: tiltClockwise .8s ease-in-out
        }
        .beam-tilt-counter-clockwise {
            animation: tiltCounterClockwise .8s ease-in-out
        }
        .fixed {
            position: fixed
        }
        .inset-0 {
            top: 0;
            right: 0;
            bottom: 0;
            left: 0
        }
        .bg-gray-800 {
            background-color: #1f2937
        }
        .bg-opacity-75 {
            background-color: rgba(31, 41, 55, .75)
        }
        .z-50 {
            z-index: 50
        }
        .max-w-md {
            max-width: 28rem
        }
        .mx-auto {
            margin-left: auto;
            margin-right: auto
        }
        .text-xl {
            font-size: 1.25rem
        }
        .mb-3 {
            margin-bottom: .75rem
        }
        .gap-3 {
            gap: .75rem
        }
        .py-2 {
            padding-top: .5rem;
            padding-bottom: .5rem
        }
        .px-4 {
            padding-left: 1rem;
            padding-right: 1rem
        }
        .bg-gray-300 {
            background-color: #d1d5db
        }
        .hover\:bg-gray-400:hover {
            background-color: #9ca3af
        }
    </style>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        // Greatest Common Denominator (GCD) using Euclidean algorithm
        const gcd = (a, b) => {
            a = Math.abs(a);
            b = Math.abs(b);
            while (b) {
                [a, b] = [b, a % b];
            }
            return a
        };

        // Simplify a fraction {numerator, denominator, sign}
        const simplifyFraction = f => {
            if (f.numerator === 0) {
                return {
                    numerator: 0,
                    denominator: 1,
                    sign: 1
                }
            }
            const c = gcd(f.numerator, f.denominator);
            return {
                numerator: f.numerator / c,
                denominator: f.denominator / c,
                sign: f.sign
            }
        };

        // Utility function to divide two fractions
        const divideFractions = (f1, f2) => {
            if (f2.numerator === 0) {
                return {
                    error: 'Divisione per zero.'
                }
            }
            const n1 = f1.numerator * f1.sign;
            const d1 = f1.denominator;
            const n2 = f2.numerator * f2.sign;
            const d2 = f2.denominator;
            const num = n1 * d2;
            const den = d1 * n2;
            let sign = 1;
            if (num < 0) {
                sign *= -1
            }
            if (den < 0) {
                sign *= -1
            }
            const s = simplifyFraction({
                numerator: Math.abs(num),
                denominator: Math.abs(den),
                sign: sign
            });
            return s
        };

        // Get display string for a fraction
        function getFractionalDisplayString(f) {
            if (!f || typeof f.numerator === 'undefined' || typeof f.denominator === 'undefined' || typeof f.sign === 'undefined') {
                return "INVALID_FRACTION"
            }
            if (f.numerator === 0) return "0";
            const s = f.sign === -1 ? "-" : "";
            return `${s}${f.numerator}${f.denominator === 1 ? '' : '/' + f.denominator}`
        }

        // Parse input string to fraction or number
        const parseFractionOrNumber = i => {
            let r = String(i).trim();
            let oS = 1; // Original Sign
            const oI = i.trim(); // Original Input
            if (r === '' || r === '(' || r === ')' || r === '[' || r === ']' || r === '{' || r === '}') {
                return {
                    error: `Formato numerico non valido: "${i}".`
                }
            }
            let hELS = false; // Has Explicit Leading Sign
            if (r.startsWith('-')) {
                oS = -1;
                r = r.substring(1).trim();
                hELS = true
            } else if (r.startsWith('+')) {
                r = r.substring(1).trim();
                hELS = true
            }
            let b = 0; // Balance for parentheses
            let tLS = []; // Trailing Slash Indices
            for (let k = 0; k < r.length; k++) {
                if (r[k] === '(') b++;
                else if (r[k] === ')') b--;
                else if (r[k] === '/' && b === 0) {
                    tLS.push(k)
                }
            }
            if (tLS.length > 1) {
                return {
                    error: `Formato frazionario ambiguo: "${i}". Utilizza le parentesi per chiarire (es. (1/2)/3 o 1/(2/3)).`
                }
            }
            let mSI = tLS.length === 1 ? tLS[0] : -1; // Main Slash Index
            let fFV; // Final Fractional Value
            let fNV; // Final Numeric Value
            if (mSI !== -1) {
                let nS = r.substring(0, mSI).trim(); // Numerator String
                let dS = r.substring(mSI + 1).trim(); // Denominator String
                let nP = parseFractionOrNumber(nS); // Numerator Parse
                if (nP.error) return {
                    error: nP.error
                };
                let dP = parseFractionOrNumber(dS); // Denominator Parse
                if (dP.error) return {
                    error: dP.error
                };
                if (dP.numericValue === 0) {
                    return {
                        error: 'Divisione per zero.'
                    }
                }
                const cF = divideFractions(nP.fractionalValue, dP.fractionalValue); // Combined Fraction
                if (cF.error) {
                    return {
                        error: cF.error
                    }
                }
                fFV = simplifyFraction(cF);
                fFV.sign *= oS;
                fNV = (fFV.numerator / fFV.denominator) * fFV.sign
            } else if (r.startsWith('(') && r.endsWith(')')) {
                let iC = r.slice(1, -1).trim(); // Inner Content
                if (iC === '') {
                    return {
                        error: `Contenuto vuoto all'interno delle parentesi: "${i}".`
                    }
                }
                const pI = parseFractionOrNumber(iC); // Parsed Inner
                if (pI.error) return {
                    error: pI.error
                };
                fFV = pI.fractionalValue;
                fFV.sign *= oS;
                fNV = (fFV.numerator / fFV.denominator) * fFV.sign
            } else {
                const sNR = /^(?:\d+(?:\.\d*)?|\.\d+)$/; // Simple Number Regex
                if (!r.match(sNR)) {
                    return {
                        error: `Formato numerico non valido: "${i}".`
                    }
                }
                const nV = parseFloat(r); // Numeric Value
                if (isNaN(nV)) {
                    return {
                        error: `Errore interno di parsing per "${i}".`
                    }
                }
                let n = nV; // Numerator
                let d = 1; // Denominator
                if (nV % 1 !== 0) {
                    const dP = (nV.toString().split('.')[1] || '').length; // Decimal Places
                    d = Math.pow(10, dP);
                    n = Math.round(nV * d)
                }
                fFV = simplifyFraction({
                    numerator: Math.abs(n),
                    denominator: d,
                    sign: (n < 0 ? -1 : 1)
                });
                fFV.sign *= oS;
                fNV = (fFV.numerator / fFV.denominator) * fFV.sign
            }
            let dS; // Display String
            if (fFV.denominator === 1) {
                dS = String(fFV.numerator * fFV.sign)
            } else {
                dS = getFractionalDisplayString(fFV)
            }
            if (fNV === 0 && Object.is(fNV, -0)) {
                dS = "0"
            }
            return {
                type: 'number',
                fractionalValue: fFV,
                numericValue: fNV,
                displayString: dS,
                originalInputString: i
            }
        };

        // Modal Component
        const Modal = ({
            isOpen,
            content,
            onConfirm,
            onCancel,
            inputRef
        }) => {
            if (!isOpen) return null;
            return (
                <div className={`fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4`}>
                    <div className="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-auto">
                        <h3 className="text-xl font-bold text-gray-800 mb-3">{content.title}</h3>
                        <p className="text-gray-700 mb-4">{content.message}</p>
                        {content.inputNeeded && (
                            <input ref={inputRef} type="text" className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400" defaultValue={content.initialValue} onKeyPress={e => {
                                if (e.key === 'Enter') onConfirm()
                            }} />
                        )}
                        <div className="flex flex-col gap-3 mt-4">
                            {content.showCancel && (
                                <button onClick={onCancel} className="py-2 px-4 rounded-md font-semibold transition-colors duration-200 w-full bg-gray-300 text-gray-800 hover:bg-gray-400">Annulla</button>
                            )}
                            <button onClick={onConfirm} className="py-2 px-4 rounded-md font-semibold transition-colors duration-200 w-full bg-blue-600 text-white hover:bg-blue-700">OK</button>
                        </div>
                    </div>
                </div>
            )
        };

        // Main App Component
        const App = () => {
            const [leftInput, setLeftInput] = React.useState(''); // Corrected
            const [rightInput, setRightInput] = React.useState(''); // Corrected
            const [resultText, setResultText] = React.useState(''); // Corrected
            const [balanceTilt, setBalanceTilt] = React.useState(0); // Corrected
            const [leftPanOffset, setLeftPanOffset] = React.useState(0); // Corrected
            const [rightPanOffset, setRightPanOffset] = React.useState(0); // Corrected
            const [error, setError] = React.useState(null); // Corrected
            const [isModalOpen, setIsModalOpen] = React.useState(false); // Corrected
            const [modalContent, setModalContent] = React.useState({ // Corrected
                type: '',
                title: '',
                message: '',
                inputNeeded: false,
                showCancel: false,
                initialValue: ''
            });
            const [modalResolve, setModalResolve] = React.useState(null); // Corrected
            const modalInputRef = React.useRef(null); // Corrected

            // Function to show custom alert modal
            const showCustomAlert = async (m, t = "Avviso") => {
                return new Promise(r => {
                    setModalContent({
                        type: 'alert',
                        title: t,
                        message: m,
                        inputNeeded: false,
                        showCancel: false,
                        initialValue: ''
                    });
                    setModalResolve(() => r);
                    setIsModalOpen(true)
                })
            };

            // Handle modal confirmation
            const handleModalConfirm = () => {
                if (modalResolve) {
                    modalResolve(modalContent.inputNeeded ? modalInputRef.current.value : true)
                }
                setIsModalOpen(false)
            };

            // Handle modal cancellation
            const handleModalCancel = () => {
                if (modalResolve) {
                    modalResolve(null)
                }
                setIsModalOpen(false)
            };

            // Handle comparison logic
            const handleCompare = async () => {
                setError(null);
                setResultText('');
                setBalanceTilt(0);
                setLeftPanOffset(0);
                setRightPanOffset(0);

                const pL = parseFractionOrNumber(leftInput);
                const pR = parseFractionOrNumber(rightInput);

                if (pL.error) {
                    setError(`Errore nel lato sinistro: ${pL.error}`);
                    await showCustomAlert(`Errore nel lato sinistro: ${pL.error}`);
                    return
                }
                if (pR.error) {
                    setError(`Errore nel lato destro: ${pR.error}`);
                    await showCustomAlert(`Errore nel lato destro: ${pR.error}`);
                    return
                }

                const lN = pL.numericValue;
                const rN = pR.numericValue;

                let cS = ''; // Comparison Sign
                let tA = 0; // Tilt Angle
                let lO = 0; // Left Offset
                let rO = 0; // Right Offset
                const pMA = 20; // Pan Max Animation

                if (lN > rN) {
                    cS = '>';
                    tA = 10;
                    lO = pMA;
                    rO = -pMA
                } else if (rN > lN) {
                    cS = '<';
                    tA = -10;
                    lO = -pMA;
                    rO = pMA
                } else {
                    cS = '=';
                    tA = 0;
                    lO = 0;
                    rO = 0
                }

                setBalanceTilt(tA);
                setLeftPanOffset(lO);
                setRightPanOffset(rO);

                const r = `${pL.displayString} ${cS} ${pR.displayString}<br/>Valori con Segno: ${pL.displayString} ${cS} ${pR.displayString}<br/>Valori Decimali: ${lN.toFixed(4)} ${cS} ${rN.toFixed(4)}`;
                setResultText(r)
            };

            // Handle clear button
            const handleClear = () => {
                setLeftInput('');
                setRightInput('');
                setResultText('');
                setBalanceTilt(0);
                setLeftPanOffset(0);
                setRightPanOffset(0);
                setError(null)
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-gray-100 to-gray-300 flex flex-col items-center justify-center p-4 font-inter">
                    <h1 className="text-4xl font-extrabold text-gray-800 mb-8 drop-shadow-md text-center">Bilancia Numerica</h1>
                    <p className="text-lg text-gray-700 mb-6 text-center max-w-2xl">Inserisci numeri, decimali o frazioni (es. `1/2`, `-3.5`, `(1/3)/2`) in entrambi i lati della bilancia per confrontarli.</p>
                    <div className="bg-white p-6 rounded-xl shadow-lg mb-6 w-full max-w-2xl">
                        <div className="flex flex-col md:flex-row gap-4 mb-6">
                            <div className="flex-1">
                                <label htmlFor="left-input" className="block text-lg font-semibold text-gray-700 mb-2">Lato Sinistro:</label>
                                <input id="left-input" type="text" value={leftInput} onChange={e => setLeftInput(e.target.value)} placeholder="Es. 1/2, -5, (3/4)" className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400" />
                            </div>
                            <div className="flex-1">
                                <label htmlFor="right-input" className="block text-lg font-semibold text-gray-700 mb-2">Lato Destro:</label>
                                <input id="right-input" type="text" value={rightInput} onChange={e => setRightInput(e.target.value)} placeholder="Es. 0.75, 1, -(2/3)" className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400" />
                            </div>
                        </div>
                        <div className="flex flex-col sm:flex-row gap-4 justify-center">
                            <button onClick={handleCompare} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 w-full sm:w-auto">Confronta</button>
                            <button onClick={handleClear} className="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 w-full sm:w-auto">Pulisci</button>
                        </div>
                        {error && (
                            <div className="text-red-600 font-bold mt-4 text-center">
                                <p>Errore: {error}</p>
                            </div>
                        )}
                        {resultText && (
                            <div className="bg-gray-50 p-4 rounded-md border border-gray-200 mt-6 text-center">
                                <p className="text-lg text-gray-800 font-semibold" dangerouslySetInnerHTML={{
                                    __html: resultText
                                }}></p>
                            </div>
                        )}
                    </div>
                    <div className="relative w-full max-w-xl aspect-video flex items-center justify-center mt-8 mb-12">
                        <svg viewBox="0 0 400 300" className="w-full h-full">
                            <rect x="150" y="250" width="100" height="20" fill="#6b7280" rx="5" ry="5" />
                            <polygon points="170,250 200,100 230,250" fill="#9ca3af" />
                            <g className={balanceTilt > 0 ? 'beam-tilt-clockwise' : balanceTilt < 0 ? 'beam-tilt-counter-clockwise' : ''} transform={`rotate(${balanceTilt}, 200, 100)`}>
                                <rect x="50" y="90" width="300" height="20" fill="#4b5563" rx="5" ry="5" />
                                <circle cx="200" cy="100" r="15" fill="#374151" />
                                <g transform={`translate(0, ${leftPanOffset})`}>
                                    <rect x="60" y="150" width="80" height="15" fill="#d1d5db" rx="5" ry="5" />
                                    <rect x="65" y="165" width="70" height="50" fill="#e5e7eb" rx="5" ry="5" />
                                    <text x="100" y="195" textAnchor="middle" fill="#374151" fontSize="18" fontWeight="bold">{leftInput || '...'}</text>
                                </g>
                                <g transform={`translate(0, ${rightPanOffset})`}>
                                    <rect x="260" y="150" width="80" height="15" fill="#d1d5db" rx="5" ry="5" />
                                    <rect x="265" y="165" width="70" height="50" fill="#e5e7eb" rx="5" ry="5" />
                                    <text x="300" y="195" textAnchor="middle" fill="#374151" fontSize="18" fontWeight="bold">{rightInput || '...'}</text>
                                </g>
                            </g>
                        </svg>
                    </div>
                    <Modal isOpen={isModalOpen} content={modalContent} onConfirm={handleModalConfirm} onCancel={handleModalCancel} inputRef={modalInputRef} />
                </div>
            )
        };
        window.onload = function() {
            if (window.ReactDOM) {
                window.ReactDOM.createRoot(document.getElementById('root')).render(<App/>)
            } else {
                console.error("ReactDOM non caricato correttamente. Controlla gli script CDN.")
            }
        };
    </script>
</body>
</html>
